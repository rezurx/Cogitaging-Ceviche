{{ define "main" }}
  <!-- Skip link for accessibility -->
  <a href="#main" class="skip">Skip to content</a>

  <!-- New Hero Section -->
  <header class="hero">
    <div class="inner">
      <h1>The Cogitating Ceviche</h1>
      <p class="subtitle">Food for Thought</p>
    </div>
  </header>

  <!-- New Navigation -->
  <nav class="site-nav">
    <div class="nav-inner">
      <a href="/" class="brand">
        <span class="logo-badge"><img src="/images/fish-logo.png" alt="The Cogitating Ceviche"></span>
        <span class="brand-text">The Cogitating Ceviche</span>
      </a>

      <button class="nav-toggle" aria-expanded="false" aria-controls="nav-links">Menu</button>

      <ul id="nav-links" class="nav-links">
        {{ range .Site.Menus.main }}
        <li><a href="{{ .URL }}" {{ if strings.HasPrefix .URL "http" }}rel="noopener"{{ end }}>{{ .Name }}</a></li>
        {{ end }}
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <main id="main" class="page">
    <div class="card-grid" id="card-grid">
      <!-- Cards will be loaded here via JavaScript -->
    </div>
    
    <!-- Loading indicator -->
    <div id="loading" class="loading">Loading articles...</div>
  </main>

  <!-- Client-side loading script -->
  <script>
    async function loadCards() {
      try {
        const res = await fetch("/data/posts.json", { cache: "no-cache" });
        const { items } = await res.json();
        
        // Ensure chronological sorting (newest first) in case it's not already sorted
        const sortedItems = items.sort((a, b) => new Date(b.published) - new Date(a.published));
        
        renderCards(sortedItems.slice(0, 30));
      } catch (error) {
        console.error('Failed to load articles:', error);
        document.getElementById('loading').textContent = 'Failed to load articles. Please refresh the page.';
      }
    }

    function renderCards(items) {
      const grid = document.getElementById('card-grid');
      const loading = document.getElementById('loading');
      
      if (!items || items.length === 0) {
        loading.textContent = 'No articles found.';
        return;
      }

      grid.innerHTML = items.map(item => {
        const publishedDate = new Date(item.published).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
        
        const imageHtml = item.image 
          ? `<img src="${item.image}" alt="${item.title}" loading="lazy" decoding="async" width="1200" height="675">`
          : `<div class="placeholder" aria-hidden="true">TC</div>`;

        // Determine source name from URL
        const sourceName = item.url.includes('thecogitatingceviche.substack.com') 
          ? 'Cogitating Ceviche' 
          : item.url.includes('thecyberneticceviche.substack.com')
          ? 'Cybernetic Ceviche'
          : 'Substack';

        return `
          <article class="card">
            <a class="card-link" href="${item.url}" aria-label="${item.title}">
              ${imageHtml}
              <div class="card-body">
                <h3>${item.title}</h3>
                ${item.subtitle ? `<p class="subtitle">${item.subtitle}</p>` : ''}
                <p class="excerpt">${item.excerpt}</p>
                <div class="meta-row">
                  <span class="chip">Read on ${sourceName}</span>
                  <time datetime="${item.published}">${publishedDate}</time>
                </div>
              </div>
            </a>
          </article>
        `;
      }).join('');

      loading.style.display = 'none';
    }

    // Navigation toggle functionality
    const btn = document.querySelector(".nav-toggle");
    const links = document.getElementById("nav-links");
    if (btn && links) {
      btn.addEventListener("click", () => {
        const open = links.classList.toggle("show");
        btn.setAttribute("aria-expanded", String(open));
      });
    }

    // Load cards when page loads
    document.addEventListener("DOMContentLoaded", loadCards);
  </script>
{{ end }}